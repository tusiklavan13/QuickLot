<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Market Table – QuickLot</title>
<link rel="stylesheet" href="style.css?v=6">
<!-- OG/Icons אופציונלי אם כבר הוספת בכל העמודים -->
</head>
<body>

<!-- NAV -->
<nav>
  <div class="navwrap">
    <a class="brand" href="index.html">QuickLot</a>
    <a href="market-table.html" class="active">Market Table</a>
    <a href="premium.html">Premium</a>
    <a href="terms.html">Terms</a>
    <a href="about.html">About</a>
  </div>
</nav>

<div class="container">
  <h1>Market Table</h1>

  <div class="card">
   <div class="grid cols-2">
  <div>
    <label class="subtle" for="timeframe">View</label>
    <select id="timeframe">
      <option value="daily">Daily</option>
      <option value="hourly">Hourly</option>
    </select>
  </div>

  <div class="grid" style="grid-template-columns: 1fr 1fr; gap:8px; align-items:end">
    <div>
      <label class="subtle" for="symFilter">Symbol</label>
      <select id="symFilter">
        <option value="ALL">All symbols</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; align-items:end">
      <input id="tblSearch" placeholder="Type to filter e.g. MNQ, MES">
      <button class="btn" id="refreshBtn" type="button">Refresh</button>
    </div>
  </div>
</div>

<div class="hr"></div>

    <div class="hr"></div>

    <div style="overflow:auto">
      <table class="table" id="marketTable">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th style="text-align:right">Trend</th>
            <th style="text-align:right">Pips/Ticks</th>
            <th style="text-align:right">$</th>
            <th style="text-align:right">%</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="subtle">Tip: Use search to filter. Switch Daily/Hourly above. Data loads from <code>market.json</code>.</p>
  </div>
</div>

<footer>© <span id="y"></span> QuickLot — For calculation purposes only. No financial advice.</footer>

<script>
// ====== symbol names (אפשר להרחיב כרצונך) ======
const SYMBOL_META = {
  MES:{name:"Micro E-mini S&P 500"},
  MNQ:{name:"Micro E-mini Nasdaq-100"},
  MYM:{name:"Micro Mini Dow"},
  M2K:{name:"Micro E-mini Russell 2000"},
  MGC:{name:"Micro Gold"},
  MCL:{name:"Micro Crude Oil"}
};

// אם אין usd ב-market.json נחסם אוטומטית לפי ערך טיק:
const TICK_VALUE = { MES:1.25, MNQ:0.50, MYM:0.50, M2K:0.50, MGC:1.00, MCL:1.00 };

// ====== state ======
let DATA = { daily:{}, hourly:{} };

const $ = s => document.querySelector(s);
const tbody = $('#marketTable tbody');
  const symFilter = document.getElementById('symFilter');
const tfSel = $('#timeframe');
const searchEl = $('#tblSearch');

(function loadPrefs(){
  try{
    const tf = localStorage.getItem('quicklot:tblTF'); if(tf) tfSel.value = tf;
    const q  = localStorage.getItem('quicklot:tblQ');  if(q) searchEl.value = q;
  }catch(e){}
})();
function savePrefs(){
  try{
    localStorage.setItem('quicklot:tblTF', tfSel.value);
    localStorage.setItem('quicklot:tblQ', searchEl.value);
  }catch(e){}
}
function populateSymFilterFromData(){
  if(!symFilter) return;
  symFilter.innerHTML = '<option value="ALL">All symbols</option>';

  const tfData = DATA.daily || {}; // לוקחים את ה-Daily כברירת מחדל
  const syms = Object.keys(tfData).sort();

  for (const s of syms){
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    symFilter.appendChild(opt);
  }
}

symFilter.addEventListener('change', render);

// ====== render ======
function render(){
  const tf  = tfSel.value;
  const q   = (searchEl.value||'').trim().toUpperCase();
  const only = (symFilter && symFilter.value) ? symFilter.value : 'ALL';

  const src = DATA[tf] || {};
  const rows = [];

  // נרוץ על הסימבולים שקיימים בפועל בקובץ הנתונים
  const fromData = Object.keys(src).sort();
  const loopSyms = (only !== 'ALL') ? [only] : fromData;

  for (const sym of loopSyms){
    const rec = src[sym];
    if(!rec) continue;

    const nice = (SYMBOL_META && SYMBOL_META[sym] && SYMBOL_META[sym].name) ? SYMBOL_META[sym].name : '';
    if(q && !sym.includes(q) && !nice.toUpperCase().includes(q)) continue;

    const tv  = TICK_VALUE ? TICK_VALUE[sym] : undefined;
    const usd = (rec.usd!=null) ? rec.usd : (isFinite(tv) ? rec.pips*tv : null);

    rows.push({sym, name:nice, trend:rec.trend, pips:rec.pips, usd, pct:rec.pct});
  }

  rows.sort((a,b)=>(b.pips||0)-(a.pips||0));

  tbody.innerHTML = rows.map(r=>{
    const ttxt = r.trend==='up'?'▲ up' : r.trend==='down'?'▼ down' : '—';
    const tcls = r.trend==='up'?'good'   : r.trend==='down'?'bad'     : '';
    return `<tr>
      <td>${r.sym}</td>
      <td>${r.name||''}</td>
      <td class="${tcls}" style="text-align:right">${ttxt}</td>
      <td style="text-align:right">${fmtNum(r.pips)}</td>
      <td style="text-align:right">${r.usd!=null?('$'+fmtNum(r.usd)):'—'}</td>
      <td style="text-align:right">${r.pct!=null?(fmtNum(r.pct)+'%'):'—'}</td>
    </tr>`;
  }).join('');

  savePrefs?.();
}

}

// ====== data load from market.json ======
async function loadData(){
  tbody.innerHTML = `<tr><td colspan="6" class="subtle">Loading market.json…</td></tr>`;
  try{
    const res = await fetch('market.json?v=' + Date.now(), {cache:'no-cache'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();
    DATA = { daily: j.daily||{}, hourly: j.hourly||{} };
populateSymFilterFromData();
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="6" class="bad">Failed to load market.json (${e.message}).</td></tr>`;
    return;
  }
  render();
}

// events
tfSel.addEventListener('change', render);
let t; searchEl.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(render,120); });
document.getElementById('refreshBtn').addEventListener('click', loadData);

// init
loadData();
document.getElementById('y').textContent=new Date().getFullYear();
</script>

</body>
</html>
